<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×¦'××˜ ×”×—×‘×¨×”</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ¢</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ... (×›×œ ×”×¢×™×¦×•×‘ ×©×œ×š ×œ×œ× ×©×™× ×•×™) ... */
    </style>
</head>
<body>
    <!-- ... (×”-HTML ×©×œ×š ×œ×œ× ×©×™× ×•×™) ... -->
    <div class="main-container">
        <div class="sidebar">
            <!-- ... (×›××• ×§×•×“×) ... -->
        </div>
        <div class="chat-area">
            <div class="tabs-area">
                <button id="tabSearch" class="tab-btn active">ğŸ” ×—×™×¤×•×©</button>
                <button id="tabGantt" class="tab-btn">ğŸ“Š ×’×× ×˜ ×ª×§×¦×™×‘</button>
            </div>
            <div id="tabSearchPanel" class="tab-panel" style="display:block;">
                <!-- ... (×›×œ ×©××¨ ×˜××‘ ×”×—×™×¤×•×©) ... -->
            </div>
            <div id="tabGanttPanel" class="tab-panel" style="display:none;">
                <div style="background:rgba(255,255,255,0.95);padding:18px 12px;border-radius:10px;max-width:700px;margin:auto;">
                    <div style="margin-bottom:10px;">
                        <label><b>×‘×—×¨ ×§× ×™×•×Ÿ (××• ×”×©××¨ ×¨×™×§ ×œ×¡×™×›×•× ×œ×›×œ ×”×§× ×™×•× ×™×):</b></label><br>
                        <select id="ganttMall" style="width:100%;font-size:16px;border-radius:7px;border:1px solid #bbb;padding:7px;">
                            <option value="">×›×œ ×”×§× ×™×•× ×™×</option>
                        </select>
                    </div>
                    <!-- ... (×©××¨ ×”×˜××‘) ... -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // ... (×›×œ ×©××¨ ×”×§×•×“ ×©×œ×š) ...

        function updateGanttMallOptions() {
            // ×œ×•×’ ×œ×¤× ×™ ×”×›×œ
            console.log('×§×¨×™××” ×œ-updateGanttMallOptions');
            if(!window.productsData) {
                console.log('productsData ×œ× ××•×’×“×¨');
                return;
            }
            if(!Array.isArray(productsData)) {
                console.log('productsData ×”×•× ×œ× ××¢×¨×š:', productsData);
                return;
            }
            if(productsData.length === 0) {
                console.log('productsData ×¨×™×§!');
                return;
            }
            console.log('productsData:', productsData.slice(0, 5), '...×¡×”"×›:', productsData.length);

            // ×‘×“×•×§ ××” ×”××¤×ª×—×•×ª ×©×œ ×”×©×•×¨×” ×”×¨××©×•× ×” (×©×•×¨×ª ×›×•×ª×¨×ª)
            if(productsData.length > 0) {
                console.log('××¤×ª×—×•×ª ×©×œ ×©×•×¨×” ×¨××©×•× ×”:', Object.keys(productsData[0]));
            }

            const mallSelect = document.getElementById('ganttMall');
            if(!mallSelect) {
                console.log('×œ× × ××¦× select ×¢× id=ganttMall');
                return;
            }
            // ×œ×•×’ ×œ×¤× ×™ ××™×¤×•×™
            const allMalls = productsData.map(p=>p['××ª×—×']);
            console.log('×›×œ ×”×¢×¨×›×™× ×‘×¢××•×“×ª ××ª×—×:', allMalls);

            const malls = Array.from(new Set(allMalls.filter(Boolean))).sort();
            console.log('×”××ª×—××™× ×”×™×™×—×•×“×™×™×:', malls);

            mallSelect.innerHTML = '<option value="">×›×œ ×”×§× ×™×•× ×™×</option>' + malls.map(m=>`<option value="${m}">${m}</option>`).join('');
            // ×œ×•×’ ××—×¨×™ ××™×œ×•×™ ×”×¨×©×™××”
            console.log('×ª×•×›×Ÿ ×”×¨×©×™××” (innerHTML):', mallSelect.innerHTML);
        }

        // (×©××¨ ×”×¤×•× ×§×¦×™×•×ª ×©×œ×š ×œ×œ× ×©×™× ×•×™)

        function afterLoadProductsForGantt(){ setTimeout(updateGanttMallOptions, 300);}
        window.addEventListener('load',function(){
            setTimeout(function() { loadExcelData(); }, 700);
            afterLoadProductsForGantt();
        });

        // ×ª×•×¡×™×£ ×œ×•×’×™× ×’× ×‘×˜×¢×™× ×ª ××§×¡×œ
        async function loadExcelData() {
            updateStatus('loading', '××ª×—×™×œ ×˜×¢×™× ×”...');
            const githubUrl = 'https://raw.githubusercontent.com/' + CONFIG.githubUser + '/' + CONFIG.githubRepo + '/main/' + CONFIG.excelFile;
            try {
                updateStatus('loading', '××ª×—×‘×¨ ×œ-GitHub...');
                const response = await fetch(githubUrl);
                if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                updateStatus('loading', '××•×¨×™×“ ×§×•×‘×¥...');
                const arrayBuffer = await response.arrayBuffer();
                if (arrayBuffer.byteLength === 0) throw new Error('×”×§×•×‘×¥ ×©×”×ª×§×‘×œ ×¨×™×§');
                updateStatus('loading', '××¢×‘×“ ×§×•×‘×¥ Excel...');
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                if (workbook.SheetNames.length === 0) throw new Error('×”×§×•×‘×¥ ×œ× ××›×™×œ ×’×œ×™×•× ×•×ª ×¢×‘×•×“×”');
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                if (jsonData.length === 0) throw new Error('×”×§×•×‘×¥ ×œ× ××›×™×œ × ×ª×•× ×™×');
                productsData = jsonData;
                console.log('productsData × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”. ××¡×¤×¨ ×¨×©×•××•×ª:', productsData.length);
                if(productsData.length > 0){
                    console.log('××¤×ª×—×•×ª ×“×•×’××”:', Object.keys(productsData[0]));
                    console.log('×¢×¨×š "××ª×—×" ×¨××©×•×Ÿ:', productsData[0]['××ª×—×']);
                }
                // ... (×©××¨ ×”×§×•×“ ×©×œ×š)
                productCount.textContent = productsData.length;
                statsCard.style.display = 'block';
                updateStatus('ready', '××•×›×Ÿ! ' + productsData.length + ' ××•×¦×¨×™×');
                addMessage('<strong>ğŸ“Š ×”××¢×¨×›×ª ××•×›× ×” ×œ×©×™××•×©!</strong><br>× ×˜×¢× ×• ×‘×”×¦×œ×—×” <strong>' + productsData.length + ' ××•×¦×¨×™×</strong> ××”×××’×¨.<br><br><strong>ğŸ‰ ××ª×” ×™×›×•×œ ×¢×›×©×™×• ×œ×”×ª×—×™×œ ×œ×—×¤×© ××•×¦×¨×™×!</strong>');
                searchInput.disabled = false;
                searchBtn.disabled = false;
                if (productsData.length > 0) {
                    const sampleFields = Object.keys(productsData[0]).join(', ');
                    addMessage('<strong>ğŸ” ×©×“×•×ª ×–××™× ×™× ×‘×§×•×‘×¥:</strong><br><code style="font-size: 12px; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 3px; word-break: break-all;">' + sampleFields + '</code>');
                }
                updateGanttMallOptions();
            } catch (error) {
                updateStatus('error', '×©×’×™××” ×‘×˜×¢×™× ×”');
                let errorHelp = '';
                if (error.message.includes('404')) errorHelp = '<strong>ğŸ” ×”×§×•×‘×¥ ×œ× × ××¦×:</strong><br>â€¢ ×‘×“×•×§ ×©×”×§×•×‘×¥ "' + CONFIG.excelFile + '" ×§×™×™× ×‘×¨×¤×•×–×™×˜×•×¨×™<br>â€¢ ×‘×“×•×§ ×©×”×©× × ×›×•×Ÿ<br>â€¢ ×‘×“×•×§ ×©×”×§×•×‘×¥ ×‘×ª×™×§×™×” ×”×¨××©×™×ª';
                else if (error.message.includes('403')) errorHelp = '<strong>ğŸ”’ ××™×Ÿ ×”×¨×©××”:</strong><br>â€¢ ×‘×“×•×§ ×©×”×¨×¤×•×–×™×˜×•×¨×™ ×¦×™×‘×•×¨×™ (Public)';
                else errorHelp = '<strong>ğŸ”§ ×©×’×™××” ×›×œ×œ×™×ª:</strong><br>â€¢ × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£<br>â€¢ ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
                addMessage('<div class="error-message"><strong>âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×:</strong><br>' + error.message + '<br><br>' + errorHelp + '</div>');
            }
        }
    </script>
</body>
</html>
