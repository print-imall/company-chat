<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת צ'אט החברה</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🏢</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ... (כל העיצוב שלך ללא שינוי) ... */
    </style>
</head>
<body>
    <!-- ... (ה-HTML שלך ללא שינוי) ... -->
    <div class="main-container">
        <div class="sidebar">
            <!-- ... (כמו קודם) ... -->
        </div>
        <div class="chat-area">
            <div class="tabs-area">
                <button id="tabSearch" class="tab-btn active">🔍 חיפוש</button>
                <button id="tabGantt" class="tab-btn">📊 גאנט תקציב</button>
            </div>
            <div id="tabSearchPanel" class="tab-panel" style="display:block;">
                <!-- ... (כל שאר טאב החיפוש) ... -->
            </div>
            <div id="tabGanttPanel" class="tab-panel" style="display:none;">
                <div style="background:rgba(255,255,255,0.95);padding:18px 12px;border-radius:10px;max-width:700px;margin:auto;">
                    <div style="margin-bottom:10px;">
                        <label><b>בחר קניון (או השאר ריק לסיכום לכל הקניונים):</b></label><br>
                        <select id="ganttMall" style="width:100%;font-size:16px;border-radius:7px;border:1px solid #bbb;padding:7px;">
                            <option value="">כל הקניונים</option>
                        </select>
                    </div>
                    <!-- ... (שאר הטאב) ... -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // ... (כל שאר הקוד שלך) ...

        function updateGanttMallOptions() {
            // לוג לפני הכל
            console.log('קריאה ל-updateGanttMallOptions');
            if(!window.productsData) {
                console.log('productsData לא מוגדר');
                return;
            }
            if(!Array.isArray(productsData)) {
                console.log('productsData הוא לא מערך:', productsData);
                return;
            }
            if(productsData.length === 0) {
                console.log('productsData ריק!');
                return;
            }
            console.log('productsData:', productsData.slice(0, 5), '...סה"כ:', productsData.length);

            // בדוק מה המפתחות של השורה הראשונה (שורת כותרת)
            if(productsData.length > 0) {
                console.log('מפתחות של שורה ראשונה:', Object.keys(productsData[0]));
            }

            const mallSelect = document.getElementById('ganttMall');
            if(!mallSelect) {
                console.log('לא נמצא select עם id=ganttMall');
                return;
            }
            // לוג לפני מיפוי
            const allMalls = productsData.map(p=>p['מתחם']);
            console.log('כל הערכים בעמודת מתחם:', allMalls);

            const malls = Array.from(new Set(allMalls.filter(Boolean))).sort();
            console.log('המתחמים הייחודיים:', malls);

            mallSelect.innerHTML = '<option value="">כל הקניונים</option>' + malls.map(m=>`<option value="${m}">${m}</option>`).join('');
            // לוג אחרי מילוי הרשימה
            console.log('תוכן הרשימה (innerHTML):', mallSelect.innerHTML);
        }

        // (שאר הפונקציות שלך ללא שינוי)

        function afterLoadProductsForGantt(){ setTimeout(updateGanttMallOptions, 300);}
        window.addEventListener('load',function(){
            setTimeout(function() { loadExcelData(); }, 700);
            afterLoadProductsForGantt();
        });

        // תוסיף לוגים גם בטעינת אקסל
        async function loadExcelData() {
            updateStatus('loading', 'מתחיל טעינה...');
            const githubUrl = 'https://raw.githubusercontent.com/' + CONFIG.githubUser + '/' + CONFIG.githubRepo + '/main/' + CONFIG.excelFile;
            try {
                updateStatus('loading', 'מתחבר ל-GitHub...');
                const response = await fetch(githubUrl);
                if (!response.ok) throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                updateStatus('loading', 'מוריד קובץ...');
                const arrayBuffer = await response.arrayBuffer();
                if (arrayBuffer.byteLength === 0) throw new Error('הקובץ שהתקבל ריק');
                updateStatus('loading', 'מעבד קובץ Excel...');
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                if (workbook.SheetNames.length === 0) throw new Error('הקובץ לא מכיל גליונות עבודה');
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                if (jsonData.length === 0) throw new Error('הקובץ לא מכיל נתונים');
                productsData = jsonData;
                console.log('productsData נטען בהצלחה. מספר רשומות:', productsData.length);
                if(productsData.length > 0){
                    console.log('מפתחות דוגמה:', Object.keys(productsData[0]));
                    console.log('ערך "מתחם" ראשון:', productsData[0]['מתחם']);
                }
                // ... (שאר הקוד שלך)
                productCount.textContent = productsData.length;
                statsCard.style.display = 'block';
                updateStatus('ready', 'מוכן! ' + productsData.length + ' מוצרים');
                addMessage('<strong>📊 המערכת מוכנה לשימוש!</strong><br>נטענו בהצלחה <strong>' + productsData.length + ' מוצרים</strong> מהמאגר.<br><br><strong>🎉 אתה יכול עכשיו להתחיל לחפש מוצרים!</strong>');
                searchInput.disabled = false;
                searchBtn.disabled = false;
                if (productsData.length > 0) {
                    const sampleFields = Object.keys(productsData[0]).join(', ');
                    addMessage('<strong>🔍 שדות זמינים בקובץ:</strong><br><code style="font-size: 12px; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 3px; word-break: break-all;">' + sampleFields + '</code>');
                }
                updateGanttMallOptions();
            } catch (error) {
                updateStatus('error', 'שגיאה בטעינה');
                let errorHelp = '';
                if (error.message.includes('404')) errorHelp = '<strong>🔍 הקובץ לא נמצא:</strong><br>• בדוק שהקובץ "' + CONFIG.excelFile + '" קיים ברפוזיטורי<br>• בדוק שהשם נכון<br>• בדוק שהקובץ בתיקיה הראשית';
                else if (error.message.includes('403')) errorHelp = '<strong>🔒 אין הרשאה:</strong><br>• בדוק שהרפוזיטורי ציבורי (Public)';
                else errorHelp = '<strong>🔧 שגיאה כללית:</strong><br>• נסה לרענן את הדף<br>• בדוק חיבור לאינטרנט';
                addMessage('<div class="error-message"><strong>❌ שגיאה בטעינת הנתונים:</strong><br>' + error.message + '<br><br>' + errorHelp + '</div>');
            }
        }
    </script>
</body>
</html>
